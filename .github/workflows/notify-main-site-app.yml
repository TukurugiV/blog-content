name: Notify Main Site (GitHub App Auth)

# GitHub Appèªè¨¼ã‚’ä½¿ç”¨ã—ãŸã‚ˆã‚Šå®‰å…¨ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³
on:
  push:
    branches: [ main ]
    paths:
      - 'blog/**'
      - 'news/**' 
      - 'events/**'
      - 'config/**'
      - 'images/**'

jobs:
  notify-main-site:
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ secrets.MAIN_REPO_OWNER }}
          repositories: ${{ secrets.MAIN_REPO_NAME }}
          
      - name: Notify main repository
        run: |
          echo "ğŸ”” Notifying main site repository about content updates..."
          echo "ğŸ“ Target repository: ${{ secrets.MAIN_REPO_OWNER }}/${{ secrets.MAIN_REPO_NAME }}"
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åˆ†é›¢
          temp_response=$(mktemp)
          
          # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã«repository_dispatchã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡
          http_code=$(curl -w "%{http_code}" -s \
            -o "$temp_response" \
            -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ steps.app-token.outputs.token }}" \
            -H "User-Agent: GitHub-Actions-Content-Updater-App" \
            https://api.github.com/repos/${{ secrets.MAIN_REPO_OWNER }}/${{ secrets.MAIN_REPO_NAME }}/dispatches \
            -d '{
              "event_type":"content-updated",
              "client_payload":{
                "repository":"${{ github.repository }}",
                "sha":"${{ github.sha }}",
                "ref":"${{ github.ref }}",
                "timestamp":"${{ github.event.head_commit.timestamp }}"
              }
            }')
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "ğŸ” HTTP Status Code: $http_code"
          
          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "$http_code" -eq 204 ]; then
            echo "âœ… Repository dispatch sent successfully via GitHub App"
          else
            echo "âŒ Failed to send repository dispatch. HTTP status: $http_code"
            if [ -s "$temp_response" ]; then
              echo "ğŸ“„ Response Body:"
              cat "$temp_response"
            fi
            exit 1
          fi
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          rm -f "$temp_response"
      
      - name: Log completion
        run: |
          echo "âœ… Content update notification sent successfully via GitHub App!"
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ’¬ Message: ${{ github.event.head_commit.message }}"