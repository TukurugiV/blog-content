name: Trigger Blog Deployment

on:
  push:
    branches: [main]
    paths:
      - 'blog/**'
      - 'news/**' 
      - 'events/**'
      - 'config/**'
      - '**.md'
      - '**.png'
      - '**.jpg'
      - '**.jpeg'
      - '**.gif'
      - '**.webp'
      - '**.svg'

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Notify blog system repository
      run: |
        echo "ğŸ“ Content updated in repository: ${{ github.repository }}"
        echo "ğŸ“‚ Changed files in this push:"
        
    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          blog/**
          news/**
          events/**
          config/**
          **.md
          **.png
          **.jpg
          **.jpeg
          **.gif
          **.webp
          **.svg
          
    - name: List changed files
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ“‹ Changed files:"
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          echo "  - $file"
        done
        
    - name: Trigger blog system deployment
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.BLOG_DEPLOY_TOKEN }}  # Personal Access Token
        script: |
          const response = await github.rest.repos.createDispatchEvent({
            owner: 'TukurugiV',  # ã‚ãªãŸã®GitHubãƒ¦ãƒ¼ã‚¶ãƒ¼åã«å¤‰æ›´
            repo: 'blog-system',  # ãƒ–ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ ãƒªãƒã‚¸ãƒˆãƒªåã«å¤‰æ›´
            event_type: 'content-updated',
            client_payload: {
              repository: context.repo.repo,
              ref: context.ref,
              sha: context.sha,
              pusher: context.payload.pusher?.name || 'unknown',
              changed_files: '${{ steps.changed-files.outputs.all_changed_files }}',
              timestamp: new Date().toISOString()
            }
          });
          
          console.log('âœ… Blog deployment triggered successfully!');
          console.log('ğŸ“¡ Repository dispatch sent to blog-system repository');
          
    - name: Skip deployment
      if: steps.changed-files.outputs.any_changed != 'true'
      run: |
        echo "â„¹ï¸ No relevant content changes detected. Skipping deployment trigger."